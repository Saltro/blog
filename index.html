<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://blog.saltroping.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://blog.saltroping.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-从上手-travis-ci-时犯的错误聊起" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/05/22/%E4%BB%8E%E4%B8%8A%E6%89%8B-travis-ci-%E6%97%B6%E7%8A%AF%E7%9A%84%E9%94%99%E8%AF%AF%E8%81%8A%E8%B5%B7/" class="article-date">
  <time datetime="2021-05-22T14:48:53.000Z" itemprop="datePublished">2021-05-22</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/CS/">CS</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/05/22/%E4%BB%8E%E4%B8%8A%E6%89%8B-travis-ci-%E6%97%B6%E7%8A%AF%E7%9A%84%E9%94%99%E8%AF%AF%E8%81%8A%E8%B5%B7/">从上手 travis ci 时犯的错误聊起</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>现在是 2021 年 5 月 22 日晚 21 点，距我开始上手 travis ci 已经过去了 5 个小时。我大约花了 4 个小时才最终配置好一个最简单的对个人主页 (<a target="_blank" rel="noopener" href="http://www.saltroping.com/">http://www.saltroping.com</a>) 的自动部署，而这 4 个小时里我走过无数弯路，犯下无数错误，甚至一度想要放弃这个想法，不过最终我还是决定把这件简单的小事做完。而正是因为这个过程非常艰难，回头看来很多错误也非常蠢笨，所以我在此复盘这个过程，以此作为一次踩坑记录和反思。</p>
<h1 id="为什么要用-travis-ci"><a href="#为什么要用-travis-ci" class="headerlink" title="为什么要用 travis ci"></a>为什么要用 travis ci</h1><p>使用 travis ci 的原因，有百分之七十是突发奇想，百分之二十是从众，百分之十是想要自动部署我的个人主页。travis 最大的好处在于可以和 Github 几乎无缝联动，使得从开发到部署整个流程非常连贯清晰。对于一个简单的静态网页自动部署来说，确实也相对方便。</p>
<h1 id="回顾大体过程"><a href="#回顾大体过程" class="headerlink" title="回顾大体过程"></a>回顾大体过程</h1><p>首先要在 travis 网页中启动 travis，之后在项目中新建 travis 配置 .travis.yml，其中包括项目语言、install 脚本、script 脚本、deploy 脚本等。之后在每次提交时，travis 便可以按照仓库中的 .travis.yml 运行。这基本就是使用 travis 的方法。 因为我要将项目部署到服务器上，因此需要 travis 在部署时能够通过 ssh 执行服务器上的半自动部署脚本。但 travis 在执行过程中并不能实现输入密码等操作，所以首先需要在服务器生成 sshkey，让 travis 携带 sshkey 公钥访问服务器，这样就可以直接通过 sshkey 登录服务器，而避免了密码操作。但直接将公钥放在项目文件中毫无疑问是非常危险的举措，所以需要让 travis 对公钥加密后上传，并在 .travis.yml 中写好解密脚本，这样 travis 执行时可以当场解密公钥。而解密脚本中需要用到一些环境变量解密，这些环境变量存放在 travis 服务器中并不公开，于是便保证了安全。</p>
<h1 id="犯下的错误和踩过的坑"><a href="#犯下的错误和踩过的坑" class="headerlink" title="犯下的错误和踩过的坑"></a>犯下的错误和踩过的坑</h1><p>一些具体操作网络上资料很多，官方文档也有说明，我就不多赘述。 但尽管如此我还是犯了很多错误踩了很多坑，我可以在此列举一下，希望能帮到和我遇到一样的问题（大概不可能）的人。 <strong>travis ci 账号未激活。</strong>这个问题大概没有人会遇到，纯属是我的问题。 <strong>iv undefined.</strong> 这出现在解密脚本中，简单来说这个报错的意思是你的<strong>环境变量没有添加到 travis 中</strong>。但一般来讲在加密文件时，travis 会自动将变量上传到服务器，不会发生上述问题。所以如果出现这个问题，有可能是你<strong>传错了 travis 服务器</strong>。travis 有多个服务器，如 travis-ci.com、travis-ci.org 等等，在执行<code>travis login</code>，<code>travis decrypt-file</code>等指令时常常会加上 –com 之类的选项表示是对哪个服务器操作，而如果没有的话则是使用 ~/.travis/config 文件中的 endpoints 所指定的服务器。如果你在加密时生成的环境变量没有上传到你在网页上使用的服务器的话，那么你在执行中便没有办法读取到解密需要用到的变量。 <strong>The command “rake” exited with 1.</strong> 这个报错可能是没有指定配置中的 install 和 script，导致 travis 不知道如何去执行脚本。一般来说，在开头指定语言后，travis 可以按照语言的默认执行方式去执行，但如果没有指定语言，就必须手动填写 install 和 script。如果和我一样希望直接跳过，那么可以直接令 install:true scipt:true。 <strong>一些 Git 和 Github 相关问题。</strong>这些问题参考资料有非常多，有时解决的方式也千奇百怪。但可以说 Git 和 Github 的问题很多时候并不能算问题，大部分时候也不会消耗太多时间精力。</p>
<h1 id="为什么总是在”解决问题”"><a href="#为什么总是在”解决问题”" class="headerlink" title="为什么总是在”解决问题”"></a>为什么总是在”解决问题”</h1><p>记得之前听过一个说法，真正的技能不是”解决问题”。如果一个声称拥有某项技能的人在处理这项任务时，只是查找各种解决方案去”解决问题”，那他不能叫拥有这项技能。 这也能解释为什么我在上手 travis 的时候总是在解决一些细枝末节的小问题，总是在踩一些坑。因为从一开始，我便是以”解决问题”的方式去做这件事情。我直接去查资料，查教程，大体看过一遍后便开始一步一步跟着做，碰到什么问题什么报错便再去查资料，不断递归。在复制粘贴指令的时候，我只考虑我的输入是什么，我的输出和教程上的输出是否一致，如果一致便继续下一步，而从没有仔细看明白其中的过程。实际上我上述的问题如果真的按照教程走的话完全不会遇到，但<strong>没有一个人写下自己的经验是为了让别人复制粘贴的</strong>，在自己上手的过程中必然会遇到不一样的状况，而想要灵活地处理各种状况就必然不能去”解决问题”，而是切实地明白这一系列步骤背后的逻辑，切实地明白这一条条命令背后的含义。 所以尽可能少地复制粘贴，尽可能多地思考为什么。不要总是去”解决问题”，而是经常去学习技能。只有脱离手把手教学的模式，才能够最高效地学习。 (封面：<a target="_blank" rel="noopener" href="http://www.pixiv.net/artworks/68401870">www.pixiv.net/artworks/68401870</a>)</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.saltroping.com/2021/05/22/%E4%BB%8E%E4%B8%8A%E6%89%8B-travis-ci-%E6%97%B6%E7%8A%AF%E7%9A%84%E9%94%99%E8%AF%AF%E8%81%8A%E8%B5%B7/" data-id="cktlfnvwj0007nxukgyk4dcqv" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-记一次使用-springboot-spring-security-vue-的前后端分离权限认证" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/04/12/%E8%AE%B0%E4%B8%80%E6%AC%A1%E4%BD%BF%E7%94%A8-springboot-spring-security-vue-%E7%9A%84%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%E6%9D%83%E9%99%90%E8%AE%A4%E8%AF%81/" class="article-date">
  <time datetime="2021-04-12T12:02:21.000Z" itemprop="datePublished">2021-04-12</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/CS/">CS</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/04/12/%E8%AE%B0%E4%B8%80%E6%AC%A1%E4%BD%BF%E7%94%A8-springboot-spring-security-vue-%E7%9A%84%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%E6%9D%83%E9%99%90%E8%AE%A4%E8%AF%81/">记一次使用 SpringBoot + Spring Security + Vue 的前后端分离权限认证</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="项目介绍"><a href="#项目介绍" class="headerlink" title="项目介绍"></a>项目介绍</h2><p>该项目是针对“权限认证”这一事务的简单实验，主要用于学习前后端分离的开发过程，以及权限认证的方式。项目使用前后端分离架构，后端使用目前流行的 Spring 框架进行开发，使用 SpringBoot 进行快速配置，通过 Spring Security 进行傻瓜式权限认证功能。前端使用 Vue3 进行开发，利用 ElmentPlus 框架设计 UI。前后端交互通过前端使用 axios 向后端 RESTapi 接口发送 ajax 请求，后端响应返回 json 数据实现。最主要的认证功能基于 Spring Security，基本没有需要手动造轮子的部分。关于数据库部分，数据库使用 MySQL 数据库，后端使用 Spring JDBCTemplate 方便数据库操作。该项目仅用于开发、演示权限认证功能，因此没有具体事务功能，只有演示用的简单事务接口和测试接口。</p>
<h2 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h2><p>在此项目中，数据库基本只用于存取用户信息与权限信息。数据库包含两张表，分别为存放用户基本信息的 sys_user 表，存放用户权限信息的 user_authority 表。sys_user 表中有三个字段，用户唯一标识符 id、用户名 name 和密码 pwd。user_authority 表中有两个字段，用户标识符 user_id 和对应用户的权限（角色） role。除 id 外字段均为 varchar 类型。</p>
<p>需要注意的是，id 尽量不要设置为 unsigned int 类型，因 Java 中不存在 unsigned int 类型，因而在读取 id 时会发生解码错误。</p>
<h2 id="后端部分"><a href="#后端部分" class="headerlink" title="后端部分"></a>后端部分</h2><h3 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h3><p>首先用 SpringBoot 搭建起一个简单的 SpringBoot 项目框架，在此我们需要用到的依赖有：web、Spring security、Springdata jdbc、lombok（减少代码量）、MySQL connector、junit（用于单元测试）。利用 Maven 导入依赖后就基本搭建好了后端开发的环境。此时项目中包括 SpringBootAplication 启动类，即整个项目的入口。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AlephApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(AlephApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同时还有 Spring 的配置文件 aplication.properties。在配置文件中配置项目所需要用到的数据库和端口。</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">server.port</span>=<span class="string">8700</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:MySQL://localhost/mis_aleph</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">mis</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">mismis</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.MySQL.cj.jdbc.Driver</span></span><br></pre></td></tr></table></figure>

<h3 id="Security-配置"><a href="#Security-配置" class="headerlink" title="Security 配置"></a>Security 配置</h3><p>在导入依赖后可以直接创建 SecurityConfig 继承 WebSecurityConfigurerAdapter 类，并实现 configure(AuthenticationManagerBuilder auth) 和 configure(HttpSecurity http) 方法。之后配置认证、登入登出、异常处理等都需要在 configure 配置中进行配置。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 配置认证方式等</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// http 相关的配置，包括登入登出、异常处理、会话管理等</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="实现-UserDetailsService"><a href="#实现-UserDetailsService" class="headerlink" title="实现 UserDetailsService"></a>实现 UserDetailsService</h3><p>为了更好地使用 Security 帮助我们进行自动认证，我们可以自定义用户详情服务，通过实现 UserDetailsService 接口，创建自定义的 user 信息服务。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDetailsServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserDetailsService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDetails <span class="title">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException </span>&#123;</span><br><span class="line">        <span class="comment">// 通过用户名查找用户信息，返回用户信息实体</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同时我们需要实现 UserDetails 接口以创建用户实体类。其中我们必须实现获取用户名、密码、用户权限方法，这样 Security 才能够接管用户服务。其他方法主要用于对用户账号进行注销等操作，此处可以忽略。代码中@Data @NoArgsConstructor @AllArgsConstructor 注解为 lombok 注解，自动实现 setter 和 getter 方法，同时配置两个构造器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserEntity</span> <span class="keyword">implements</span> <span class="title">UserDetails</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String userPwd;</span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; roles;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserEntity</span><span class="params">(String username, String userPwd, List&lt;String&gt; roles)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.username = username;</span><br><span class="line">        <span class="keyword">this</span>.userPwd = userPwd;</span><br><span class="line">        <span class="keyword">this</span>.roles = roles;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Collection&lt;? extends GrantedAuthority&gt; getAuthorities() &#123;</span><br><span class="line">        List&lt;SimpleGrantedAuthority&gt; authorities = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (String role: roles) &#123;</span><br><span class="line">            authorities.add(<span class="keyword">new</span> SimpleGrantedAuthority(role));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> authorities;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPassword</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userPwd;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUsername</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAccountNonExpired</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAccountNonLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isCredentialsNonExpired</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isEnabled</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有了 User 实体类后，我们需要一个 repository 帮助我们进行数据库的增删改查操作，方便创建、查找 User。使用 Spring 的@Repository 注解将 UserRepository 注册到 Spring 上下文中，这样可以在其他类中进行自动配置。通过@Autowired 自动注入 jdbc 模板加速开发，之后只需要在数据库中依据用户名查找用户即可。查找到全部的用户信息后，返回一个 UserDetails 对象。</p>
<p>需要注意的是如果数据库中没有该用户，则会抛出 EmptyResultDataAccessException 异常。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserRepository</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JdbcTemplate jdbc;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserRepository</span><span class="params">(JdbcTemplate jdbc)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.jdbc = jdbc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserEntity <span class="title">findUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> EmptyResultDataAccessException </span>&#123;</span><br><span class="line">        String SQL = <span class="string">&quot;select * from sys_user where name=?&quot;</span>;</span><br><span class="line">        Map&lt;String, Object&gt; user = jdbc.queryForMap(SQL, username);</span><br><span class="line">        SQL = <span class="string">&quot;select role from user_authority where user_id=?&quot;</span>;</span><br><span class="line">        List&lt;Map&lt;String, Object&gt;&gt; user_authes = jdbc.queryForList(SQL, user.get(<span class="string">&quot;id&quot;</span>));</span><br><span class="line">        List&lt;String&gt; roles = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (Map&lt;String, Object&gt; auth: user_authes) &#123;</span><br><span class="line">            roles.add((String) auth.get(<span class="string">&quot;role&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> UserEntity(</span><br><span class="line">                (<span class="keyword">int</span>) user.get(<span class="string">&quot;id&quot;</span>),  <span class="comment">// 数据库中 id 不为 unsigned int 才能取出为 int 类型，否则为 long</span></span><br><span class="line">                (String) user.get(<span class="string">&quot;name&quot;</span>),</span><br><span class="line">                (String) user.get(<span class="string">&quot;pwd&quot;</span>),</span><br><span class="line">                roles);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有了 UserRepository 后，便可以将其注入到 UserDetailsService 中。直接调用 repository 的方法便可直接返回用户实体。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDetailsServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserDetailsService</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserRepository userRepository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserDetailsServiceImpl</span><span class="params">(UserRepository userRepository)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 注入 UserRepository</span></span><br><span class="line">        <span class="keyword">this</span>.userRepository = userRepository;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDetails <span class="title">loadUserByUsername</span><span class="params">(String s)</span> <span class="keyword">throws</span> UsernameNotFoundException </span>&#123;</span><br><span class="line">        <span class="comment">// 通过用户名查找用户信息，返回用户信息实体</span></span><br><span class="line">        <span class="keyword">return</span> userRepository.findUserByUsername(s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后我们将实现好的 UserDetailsService 注入到 SecurityConfig 配置中去，这样我们自定义的用户信息服务便会生效。在注入时用@Qualifier 注解标注我们要注入哪一个实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserDetailsService userDetailsService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  推荐使用构造器进行注入</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SecurityConfig</span><span class="params">(<span class="meta">@Qualifier(&quot;userDetailsServiceImpl&quot;)</span> UserDetailsService userDetailsService)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userDetailsService = userDetailsService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 配置认证方式等</span></span><br><span class="line">        auth</span><br><span class="line">                .userDetailsService(userDetailsService);  <span class="comment">// 将用户详情服务配置到 Spring Security 上</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// http 相关的配置，包括登入登出、异常处理、会话管理等</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="密码加密"><a href="#密码加密" class="headerlink" title="密码加密"></a>密码加密</h3><p>新版本的 Spring security 规定必须设置一个默认的加密方式，不允许使用明文。这个加密方式是用于在登录时验证密码、注册时需要用到。在此我们选择标准加密。通过@Bean 注解，我们可以只将其写在 SecurityConfig 中就完成注册。之后同上在 SecurityConfig 中完成配置，这样 Security 在认证时就会自动采用加密认证。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> PasswordEncoder <span class="title">encoder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> StandardPasswordEncoder(<span class="string">&quot;7t89yo&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// 配置认证方式等</span></span><br><span class="line">    auth</span><br><span class="line">            .userDetailsService(userDetailsService)  <span class="comment">// 将用户详情服务配置到 Spring Security 上</span></span><br><span class="line">            .passwordEncoder(encoder());  <span class="comment">// 在全局中使用加密</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="用户登入登出"><a href="#用户登入登出" class="headerlink" title="用户登入登出"></a>用户登入登出</h3><p>Spring Security 默认的登入路径是/login 登出路径是/logout，向路径发送 post 请求传入用户名 username 和密码 password 即可实现登入或登出。但 Spring Security 默认设置了 csrf 拦截，导致 post 请求默认被拦截，因此我们需要对几个路径配置 csrf token 准许 post 请求通过。这样前端可以向后端的注册、登入、登出路径发送请求。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// http 相关的配置，包括登入登出、异常处理、会话管理等</span></span><br><span class="line">    <span class="comment">// 设置 csrf token，防止 post 请求拦截</span></span><br><span class="line">    http</span><br><span class="line">            .csrf().csrfTokenRepository(CookieCsrfTokenRepository.withHttpOnlyFalse())</span><br><span class="line">            .ignoringAntMatchers(<span class="string">&quot;/register&quot;</span>, <span class="string">&quot;/login&quot;</span>, <span class="string">&quot;/logout&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>之后为了处理登入的反馈，我们需要实现权限认证成功处理器和失败处理器。处理器会在登入后依据认证情况进行响应，如果成功则会执行成功处理器，反之执行失败处理器。因此需要实现 AuthenticationSuccessHandler 和 AuthenticationFailureHandler 接口。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span>  <span class="comment">// 注册 Spring 上下文</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthSuccessHandler</span> <span class="keyword">implements</span> <span class="title">AuthenticationSuccessHandler</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAuthenticationSuccess</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Authentication authentication)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以 AuthSuccessHandler 为例，需要实现 onAuthenticationSuccess 方法，参数有 http 请求体、响应体和权限。在此我们需要做的应该是，在登入成功后后端应该返回标志着登录成功的 json 响应数据。</p>
<p>为此首先我们要统一状态码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">ReturnStatus</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 响应正常</span></span><br><span class="line">    SUCCESS(<span class="number">1000</span>, <span class="string">&quot;服务器响应正常&quot;</span>),</span><br><span class="line">    RESPONSE_SUCCESS(<span class="number">1001</span>, <span class="string">&quot;服务器响应正常且数据操作正常&quot;</span>),</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 事务异常</span></span><br><span class="line">    TRANSACTION_ERROR(<span class="number">2000</span>, <span class="string">&quot;事务操作异常&quot;</span>),</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 服务器非正常</span></span><br><span class="line">    SERVER_ERROR(<span class="number">3000</span>, <span class="string">&quot;服务器异常&quot;</span>),</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 用户非正常</span></span><br><span class="line">    USER_AUTH_DENY(<span class="number">4000</span>, <span class="string">&quot;用户权限不足&quot;</span>),</span><br><span class="line">    USER_PASSWORD_ERROR(<span class="number">4001</span>, <span class="string">&quot;用户密码错误&quot;</span>),</span><br><span class="line">    USER_ACCOUNT_EXPIRED(<span class="number">4002</span>, <span class="string">&quot;用户账号过期&quot;</span>),</span><br><span class="line">    USER_PASSWORD_EXPIRED(<span class="number">4003</span>, <span class="string">&quot;用户密码过期&quot;</span>),</span><br><span class="line">    USER_ACCOUNT_DISABLE(<span class="number">4004</span>, <span class="string">&quot;用户账号不可用&quot;</span>),</span><br><span class="line">    USER_ACCOUNT_LOCKED(<span class="number">4005</span>, <span class="string">&quot;用户账号锁定&quot;</span>),</span><br><span class="line">    USER_ACCOUNT_NOT_EXIST(<span class="number">4006</span>, <span class="string">&quot;用户不存在&quot;</span>),</span><br><span class="line">    USER_NOT_LOGIN(<span class="number">4007</span>, <span class="string">&quot;用户未登录&quot;</span>),</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 其他错误</span></span><br><span class="line">    COMMON_ERROR(<span class="number">9000</span>, <span class="string">&quot;未知错误&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> statusCode;</span><br><span class="line">    <span class="keyword">private</span> String statusMsg;</span><br><span class="line"></span><br><span class="line">    ReturnStatus(<span class="keyword">int</span> statusCode, String statusMsg) &#123;</span><br><span class="line">        <span class="keyword">this</span>.statusCode = statusCode;</span><br><span class="line">        <span class="keyword">this</span>.statusMsg = statusMsg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getStatusCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> statusCode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setStatusCode</span><span class="params">(<span class="keyword">int</span> statusCode)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.statusCode = statusCode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getStatusMsg</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> statusMsg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setStatusMsg</span><span class="params">(String statusMsg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.statusMsg = statusMsg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getMsgByCode</span><span class="params">(<span class="keyword">int</span> statusCode)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (ReturnStatus rs: ReturnStatus.values()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (rs.getStatusCode() == statusCode) <span class="keyword">return</span> rs.getStatusMsg();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>之后构造统一的返回体工具类，辅助构建 json 响应数据。我们预期的返回体构成如下。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;statusCode&quot;</span>: <span class="string">&quot;xxx&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;statusMsg&quot;</span>: <span class="string">&quot;xxx&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;data&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;xxx&quot;</span>: <span class="string">&quot;xxx&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因此构建 ReturnJsonUtil 类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReturnJsonUtil</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> statusCode;</span><br><span class="line">    <span class="keyword">private</span> String statusMsg;</span><br><span class="line">    <span class="keyword">private</span> T data;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ReturnJsonUtil</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ReturnJsonUtil</span><span class="params">(ReturnStatus rs)</span> </span>&#123;</span><br><span class="line">        statusCode = rs.getStatusCode();</span><br><span class="line">        statusMsg = rs.getStatusMsg();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ReturnJsonUtil</span><span class="params">(<span class="keyword">int</span> statusCode, T data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.statusCode = statusCode;</span><br><span class="line">        statusMsg = ReturnStatus.getMsgByCode(statusCode);</span><br><span class="line">        <span class="keyword">this</span>.data = data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ReturnJsonUtil</span><span class="params">(<span class="keyword">int</span> statusCode)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.statusCode = statusCode;</span><br><span class="line">        statusMsg = ReturnStatus.getMsgByCode(statusCode);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setStatusCode</span><span class="params">(<span class="keyword">int</span> statusCode)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.statusCode = statusCode;</span><br><span class="line">        statusMsg = ReturnStatus.getMsgByCode(statusCode);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setStatus</span><span class="params">(ReturnStatus rs)</span> </span>&#123;</span><br><span class="line">        statusCode = rs.getStatusCode();</span><br><span class="line">        statusMsg = rs.getStatusMsg();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setData</span><span class="params">(T data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.data = data;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>之后便可以在登入成功处理器中使用返回体工具来向响应体中写入 json 格式的数据，以此返回前端。此处使用 jackson 的 objectmapper 将对象解析为 json 字符串写入 response 响应体。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span>  <span class="comment">// 注册 Spring 上下文</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthSuccessHandler</span> <span class="keyword">implements</span> <span class="title">AuthenticationSuccessHandler</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAuthenticationSuccess</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Authentication authentication)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        httpServletResponse.setContentType(<span class="string">&quot;text/json;charset=utf-8&quot;</span>);  <span class="comment">// 设置返回数据格式为 json</span></span><br><span class="line">        ObjectMapper objectMapper = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">        ReturnJsonUtil&lt;Object&gt; rj = <span class="keyword">new</span> ReturnJsonUtil&lt;&gt;(ReturnStatus.SUCCESS);</span><br><span class="line">        objectMapper.writeValue(httpServletResponse.getWriter(), rj);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同理实现 AuthenticationFailureHandler 接口响应登入失败状况。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthFailureHandler</span> <span class="keyword">implements</span> <span class="title">AuthenticationFailureHandler</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAuthenticationFailure</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, AuthenticationException e)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        ReturnJsonUtil&lt;Object&gt; rj = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (e <span class="keyword">instanceof</span> AccountExpiredException) &#123;</span><br><span class="line">            <span class="comment">//账号过期</span></span><br><span class="line">            rj = <span class="keyword">new</span> ReturnJsonUtil&lt;&gt;(ReturnStatus.USER_ACCOUNT_EXPIRED);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> BadCredentialsException) &#123;</span><br><span class="line">            <span class="comment">//密码错误</span></span><br><span class="line">            rj = <span class="keyword">new</span> ReturnJsonUtil&lt;&gt;(ReturnStatus.USER_PASSWORD_ERROR);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> CredentialsExpiredException) &#123;</span><br><span class="line">            <span class="comment">//密码过期</span></span><br><span class="line">            rj = <span class="keyword">new</span> ReturnJsonUtil&lt;&gt;(ReturnStatus.USER_PASSWORD_EXPIRED);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> DisabledException) &#123;</span><br><span class="line">            <span class="comment">//账号不可用</span></span><br><span class="line">            rj = <span class="keyword">new</span> ReturnJsonUtil&lt;&gt;(ReturnStatus.USER_ACCOUNT_DISABLE);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> LockedException) &#123;</span><br><span class="line">            <span class="comment">//账号锁定</span></span><br><span class="line">            rj = <span class="keyword">new</span> ReturnJsonUtil&lt;&gt;(ReturnStatus.USER_ACCOUNT_LOCKED);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> InternalAuthenticationServiceException) &#123;</span><br><span class="line">            <span class="comment">//用户不存在</span></span><br><span class="line">            rj = <span class="keyword">new</span> ReturnJsonUtil&lt;&gt;(ReturnStatus.USER_ACCOUNT_NOT_EXIST);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">//其他错误</span></span><br><span class="line">            rj = <span class="keyword">new</span> ReturnJsonUtil&lt;&gt;(ReturnStatus.COMMON_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        httpServletResponse.setContentType(<span class="string">&quot;text/json;charset=utf-8&quot;</span>);</span><br><span class="line">        ObjectMapper objectMapper = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">        objectMapper.writeValue(httpServletResponse.getWriter(), rj);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后将写好的处理器配置到 SecurityConfig 中去，完成登入配置。同时要先将处理器注入。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> AuthSuccessHandler authSuccessHandler;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> AuthFailureHandler authFailureHandler;</span><br><span class="line"></span><br><span class="line"><span class="comment">//  推荐使用构造器进行注入</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">SecurityConfig</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="meta">@Qualifier(&quot;userDetailsServiceImpl&quot;)</span> UserDetailsService userDetailsService,</span></span></span><br><span class="line"><span class="params"><span class="function">    AuthSuccessHandler authSuccessHandler,</span></span></span><br><span class="line"><span class="params"><span class="function">    AuthFailureHandler authFailureHandler)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.userDetailsService = userDetailsService;</span><br><span class="line">    <span class="keyword">this</span>.authSuccessHandler = authSuccessHandler;</span><br><span class="line">    <span class="keyword">this</span>.authFailureHandler = authFailureHandler;</span><br><span class="line">&#125;</span><br><span class="line">......</span><br><span class="line">http</span><br><span class="line">        .formLogin()  <span class="comment">// 配置登入</span></span><br><span class="line">        .loginProcessingUrl(<span class="string">&quot;/login&quot;</span>)  <span class="comment">// 设置登录接口路径，登录方式为 post 请求，字段为用户名 username 及密码 password</span></span><br><span class="line">        .successHandler(authSuccessHandler)  <span class="comment">// 注入成功处理器</span></span><br><span class="line">        .failureHandler(authFailureHandler)  <span class="comment">// 注入失败处理器</span></span><br><span class="line">        .permitAll();  <span class="comment">// 允许所有用户访问（包括匿名用户</span></span><br></pre></td></tr></table></figure>

<p>登出配置基本同理，响应登出成功需要实现 LogoutSuccessHandler 接口。从用户体验角度出发，没有登入的用户是不能进行登出，因此我们判断此处权限是否为空，若为空则代表用户没有权限，返回用户未登录状态码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccountLogoutSuccessHandler</span> <span class="keyword">implements</span> <span class="title">LogoutSuccessHandler</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLogoutSuccess</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Authentication authentication)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        httpServletResponse.setContentType(<span class="string">&quot;text/json;charset=utf-8&quot;</span>);</span><br><span class="line">        ObjectMapper objectMapper = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">        ReturnJsonUtil&lt;Object&gt; rj;</span><br><span class="line">        <span class="keyword">if</span> (authentication != <span class="keyword">null</span>) &#123;</span><br><span class="line">            rj = <span class="keyword">new</span> ReturnJsonUtil&lt;&gt;(ReturnStatus.SUCCESS);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            rj = <span class="keyword">new</span> ReturnJsonUtil&lt;&gt;(ReturnStatus.USER_NOT_LOGIN);</span><br><span class="line">        &#125;</span><br><span class="line">        objectMapper.writeValue(httpServletResponse.getWriter(), rj);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在配置到 SecurityConfig 时，我们需要在用户登出时删除 JSESSIONID 的 Cookie，以确保用户正常登出。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">http</span><br><span class="line">        .formLogin()  <span class="comment">// 配置登入</span></span><br><span class="line">            .loginProcessingUrl(<span class="string">&quot;/login&quot;</span>)  <span class="comment">// 设置登录接口路径，登录方式为 post 请求，字段为用户名 username 及密码 password</span></span><br><span class="line">            .successHandler(authSuccessHandler)  <span class="comment">// 注入成功处理器</span></span><br><span class="line">            .failureHandler(authFailureHandler)  <span class="comment">// 注入失败处理器</span></span><br><span class="line">            .permitAll()  <span class="comment">// 允许所有用户访问（包括匿名用户</span></span><br><span class="line">        .and()</span><br><span class="line">            .logout()</span><br><span class="line">            .logoutSuccessHandler(accountLogoutSuccessHandler)  <span class="comment">// 注入登出处理器</span></span><br><span class="line">            .deleteCookies(<span class="string">&quot;JSESSIONID&quot;</span>);  <span class="comment">// 登出时删除 JSESSIONID</span></span><br></pre></td></tr></table></figure>

<h3 id="权限设置与匿名用户"><a href="#权限设置与匿名用户" class="headerlink" title="权限设置与匿名用户"></a>权限设置与匿名用户</h3><p>在 SecurityConfig 中我们可以自由地配置不同路径下的权限。如下代码中我们对/api/user/**路径设置了角色权限，只有拥有 USER 角色的用户才能够正常访问，而/api/admin/**路径只允许 ADMIN 角色访问。/register 和/register/下的所有路径允许所有用户访问，而除此之外的路径至少先通过认证才能访问。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">http</span><br><span class="line">        .authorizeRequests()</span><br><span class="line">            .antMatchers(<span class="string">&quot;/api/user/**&quot;</span>).hasRole(<span class="string">&quot;USER&quot;</span>)  <span class="comment">// 使用 /api/user/** 而不是 /api/user  ** 为通配符</span></span><br><span class="line">            .antMatchers(<span class="string">&quot;/api/admin/**&quot;</span>).hasRole(<span class="string">&quot;ADMIN&quot;</span>)</span><br><span class="line">            .antMatchers(<span class="string">&quot;/register&quot;</span>, <span class="string">&quot;/register/**&quot;</span>).permitAll()</span><br><span class="line">            .antMatchers(<span class="string">&quot;/**&quot;</span>).authenticated();</span><br></pre></td></tr></table></figure>

<p>这样一个普通的用户便无法访问到/api/admin/下的任何路径了。但如果未登录用户访问高权限数据，请求会被重定向至登入界面，这并不符合我们的设计。我们需要用户在访问被拒绝时返回统一的 json 数据。因此我们需要屏蔽重定向页面，并在在 httpconfig 中设置匿名用户的异常处理。实现这一功能的核心就是实现 AuthenticationEntryPoint 接口。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthEntryPoint</span> <span class="keyword">implements</span> <span class="title">AuthenticationEntryPoint</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">commence</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, AuthenticationException e)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        ReturnJsonUtil&lt;Object&gt; rj = <span class="keyword">new</span> ReturnJsonUtil&lt;&gt;(ReturnStatus.USER_NOT_LOGIN);</span><br><span class="line">        httpServletResponse.setContentType(<span class="string">&quot;text/json;charset=utf-8&quot;</span>);</span><br><span class="line">        ObjectMapper objectMapper = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">        objectMapper.writeValue(httpServletResponse.getWriter(), rj);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后配置到 SecurityConfig 中，同样 authEntryPoint 也需要注入。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">http</span><br><span class="line">    .authorizeRequests()</span><br><span class="line">        .antMatchers(<span class="string">&quot;/api/user/**&quot;</span>).hasRole(<span class="string">&quot;USER&quot;</span>)  <span class="comment">// 使用 /api/user/** 而不是 /api/user</span></span><br><span class="line">        .antMatchers(<span class="string">&quot;/api/admin/**&quot;</span>).hasRole(<span class="string">&quot;ADMIN&quot;</span>)</span><br><span class="line">        .antMatchers(<span class="string">&quot;/register&quot;</span>, <span class="string">&quot;/register/**&quot;</span>).permitAll()</span><br><span class="line">        .antMatchers(<span class="string">&quot;/**&quot;</span>).authenticated()</span><br><span class="line">    .and()</span><br><span class="line">        .formLogin()</span><br><span class="line">        .loginProcessingUrl(<span class="string">&quot;/login&quot;</span>)  <span class="comment">// 设置登录接口路径，登录方式为 post 请求，字段为用户名 username 及密码 password</span></span><br><span class="line">        .successHandler(authSuccessHandler)  <span class="comment">// 注入成功处理器</span></span><br><span class="line">        .failureHandler(authFailureHandler)  <span class="comment">// 注入失败处理器</span></span><br><span class="line">        .permitAll()</span><br><span class="line">    .and()</span><br><span class="line">        .logout()</span><br><span class="line">        .logoutSuccessHandler(accountLogoutSuccessHandler)  <span class="comment">// 注入登出处理器</span></span><br><span class="line">        .deleteCookies(<span class="string">&quot;JSESSIONID&quot;</span>)  <span class="comment">// 登出时删除 JSESSIONID</span></span><br><span class="line">    .and()</span><br><span class="line">        .exceptionHandling()  <span class="comment">// 异常处理</span></span><br><span class="line">        .authenticationEntryPoint(authEntryPoint);</span><br></pre></td></tr></table></figure>

<p>这样前端的匿名用户在访问高权限数据时也能够接收到 json 响应了。</p>
<h3 id="用户注册"><a href="#用户注册" class="headerlink" title="用户注册"></a>用户注册</h3><p>Sping Security 没有支持用户注册，因此我们需要手动编写用户注册接口。本质上用户注册接口就是接收前端传来的数据，将其保存到数据库中，再向前端响应。因此我们只是需要实现一个 RestController 控制器。</p>
<p>当然首先我们需要能够保存数据至数据库，即在 UserRepository 中实现 saveWithoutId 方法。首先判断用户名是否已存在。当用户名不存在时，我们需要先将用户名用户密码存入 sys_user 表中，然后再得到它自动创建的 id，再使用 id 将用户权限信息存入 user_authority 表中。因此我们需要 KeyHolder 帮助我们在插入数据时保留插入行的数据，以此得到用户 id。而为了让 jdbc 能够支持 KeyHolder，我们又需要创建 PreparedStatementCreator，这样才能够在 PreparedStatement 执行中使用 KeyHolder。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveWithoutId</span><span class="params">(UserEntity user)</span> <span class="keyword">throws</span> UsernameAlreadyExistsException </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        findUserByUsername(user.getUsername());</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UsernameAlreadyExistsException();  <span class="comment">// 如果用户名已存在抛出 UsernameAlreadyExistsException 异常</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (EmptyResultDataAccessException ignored) &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    PreparedStatementCreator psc = <span class="keyword">new</span> PreparedStatementCreator() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> PreparedStatement <span class="title">createPreparedStatement</span><span class="params">(Connection connection)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">            PreparedStatement ps = connection.prepareStatement(<span class="string">&quot;insert into sys_user(name, pwd) values(?,?)&quot;</span>, Statement.RETURN_GENERATED_KEYS);  <span class="comment">// Statement.RETURN_GENERATED_KEYS) 确保能够使用 KeyHolder 返回值</span></span><br><span class="line">            ps.setString(<span class="number">1</span>, user.getUsername());</span><br><span class="line">            ps.setString(<span class="number">2</span>, user.getPassword());</span><br><span class="line">            <span class="keyword">return</span> ps;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    KeyHolder keyHolder = <span class="keyword">new</span> GeneratedKeyHolder();</span><br><span class="line">    jdbc.update(psc, keyHolder);</span><br><span class="line">    <span class="keyword">int</span> userId = keyHolder.getKey().intValue();</span><br><span class="line">    String SQL = <span class="string">&quot;insert into user_authority values(?,?)&quot;</span>;</span><br><span class="line">    List&lt;String&gt; roles = user.getRoles();</span><br><span class="line">    <span class="keyword">for</span> (String role: roles) &#123;</span><br><span class="line">        jdbc.update(SQL, userId, role);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>能够存储用户信息还不够，我们需要能够接收前端传来的用户注册信息数据，即用户名和用户密码。对于接收数据，我们只需要建立一个 form 实体对象，Spring 会自动进行对象映射。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RegistrationForm</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String userPwd;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserEntity <span class="title">toUser</span><span class="params">(PasswordEncoder passwordEncoder)</span> </span>&#123;</span><br><span class="line">        List&lt;String&gt; role = Arrays.asList(<span class="string">&quot;ROLE_USER&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> UserEntity(username, passwordEncoder.encode(userPwd), role);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在前端发送数据后，会将数据一一映射形成对象，controller 只需处理对象即可。使用@RestController 可以注册为 RestController，使得控制器不再操作视图，使用@RequestMapping(path = “/register”) 注解标注要监听的路径，使用@CrossOrigin(origins = “*“) 注解来允许跨域请求。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(path = &quot;/register&quot;)</span></span><br><span class="line"><span class="meta">@CrossOrigin(origins = &quot;*&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RegisterRESTController</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserRepository userRepository;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PasswordEncoder passwordEncoder;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RegisterRESTController</span><span class="params">(UserRepository userRepository,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  PasswordEncoder passwordEncoder)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userRepository = userRepository;</span><br><span class="line">        <span class="keyword">this</span>.passwordEncoder = passwordEncoder;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ReturnJsonUtil&lt;Object&gt; <span class="title">userRegistration</span><span class="params">(RegistrationForm form)</span> </span>&#123;</span><br><span class="line">        ReturnJsonUtil&lt;Object&gt; rj = <span class="keyword">new</span> ReturnJsonUtil&lt;&gt;();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            userRepository.saveWithoutId(form.toUser(passwordEncoder));</span><br><span class="line">            rj.setStatus(ReturnStatus.RESPONSE_SUCCESS);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (UsernameAlreadyExistsException e) &#123;</span><br><span class="line">            rj.setStatus(ReturnStatus.TRANSACTION_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> rj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>需要注意的是，因为我们在认证中使用了加密认证，因此我们在存储密码时也需要先将用户密码进行加密存储，因此在 form 对象的 toUser 方法中，传入之前定义过的 PasswordEncoder 对象进行加密，生成加密后的用户对象。</p>
<h3 id="简单的事务处理"><a href="#简单的事务处理" class="headerlink" title="简单的事务处理"></a>简单的事务处理</h3><p>至此我们基本完成了 Spring Security 的全部配置，因此我们写一个最简单的控制器来测试我们的配置。只要用户请求，服务器便会记录下用户名和用户权限，并返回成功信息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(path = &quot;/api&quot;)</span></span><br><span class="line"><span class="meta">@CrossOrigin(origins = &quot;*&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommonApiRESTController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/user/common&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ReturnJsonUtil&lt;Object&gt; <span class="title">userCommonRequest</span><span class="params">(<span class="meta">@AuthenticationPrincipal</span> UserEntity user)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;User: &quot;</span>+user.getUsername()+<span class="string">&quot; Authorities: &quot;</span>+user.getAuthorities());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ReturnJsonUtil&lt;&gt;(ReturnStatus.SUCCESS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/admin/common&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ReturnJsonUtil&lt;Object&gt; <span class="title">adminCommonRequest</span><span class="params">(<span class="meta">@AuthenticationPrincipal</span> UserEntity user)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;User: &quot;</span>+user.getUsername()+<span class="string">&quot; Authorities: &quot;</span>+user.getAuthorities());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ReturnJsonUtil&lt;&gt;(ReturnStatus.SUCCESS);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>后端搭建基本完毕，运行 SpringBootApplication 类便可启动后端。</p>
<h2 id="前端部分"><a href="#前端部分" class="headerlink" title="前端部分"></a>前端部分</h2><h3 id="环境-1"><a href="#环境-1" class="headerlink" title="环境"></a>环境</h3><p>前端使用 VueCLI 搭建开发环境，使用 vue 指令便可快速搭建好前端开发环境，同时在项目目录中安装 ElementPlus 和 axios 模块。配置环境在项目目录下新建 vue.config.js 文件，配置如下。最核心的配置是 proxy 代理，将对当前服务器的请求代理到后端服务器，以此实现开发环境下的前后端交互（生产环境一般采用 Nginx 配置）。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="attr">devServer</span>: &#123;</span><br><span class="line">    <span class="attr">open</span>: <span class="literal">true</span>,  <span class="comment">// 自动打开浏览器</span></span><br><span class="line">    <span class="attr">host</span>: <span class="string">&#x27;localhost&#x27;</span>,</span><br><span class="line">    <span class="attr">port</span>: <span class="number">8600</span>,</span><br><span class="line">    <span class="attr">proxy</span>: &#123;</span><br><span class="line">      <span class="string">&#x27;/api&#x27;</span>: &#123;</span><br><span class="line">        <span class="attr">target</span>: <span class="string">&#x27;http://localhost:8700&#x27;</span>,</span><br><span class="line">        <span class="attr">changeOrigin</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">ws</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">pathRewrite</span>: &#123;</span><br><span class="line">          <span class="string">&#x27;^/api&#x27;</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="组件开发"><a href="#组件开发" class="headerlink" title="组件开发"></a>组件开发</h3><p>之后便是各个页面（组件）的开发，单以登录组件为例，首先在 Login.vue 中依靠 ElementPlus 写一个模板。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">el-card</span> <span class="attr">class</span>=<span class="string">&quot;index-card&quot;</span> <span class="attr">shadow</span>=<span class="string">&quot;always&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h3</span>&gt;</span> 登录 <span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">el-form</span> <span class="attr">:model</span>=<span class="string">&quot;form&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">el-form-item</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">el-input</span> <span class="attr">v-model</span>=<span class="string">&quot;form.username&quot;</span> <span class="attr">maxlength</span>=<span class="string">&quot;30&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;用户名&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">el-input</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">el-form-item</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">el-form-item</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">el-input</span> <span class="attr">v-model</span>=<span class="string">&quot;form.userPwd&quot;</span> <span class="attr">maxlength</span>=<span class="string">&quot;30&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;密码&quot;</span> <span class="attr">show-password</span>&gt;</span><span class="tag">&lt;/<span class="name">el-input</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">el-form-item</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">el-button</span> <span class="attr">class</span>=<span class="string">&quot;login-submit&quot;</span> <span class="attr">type</span>=<span class="string">&quot;primary&quot;</span> @<span class="attr">click</span>=<span class="string">&quot;submit&quot;</span>&gt;</span> 登录 <span class="tag">&lt;/<span class="name">el-button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">el-form</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">el-card</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>之后配置其绑定的 data 和 methods，即 form 数据和 submit 方法，form 数据同表单绑定，而 submit 方法在登录按钮点击时触发。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;Login&#x27;</span>,</span><br><span class="line">  <span class="function"><span class="title">data</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">form</span>: &#123;</span><br><span class="line">        <span class="attr">username</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="attr">userPwd</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">methods</span>: &#123;</span><br><span class="line">    <span class="function"><span class="title">submit</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>之后实现 submit 方法。submit 首先需要判断用户名、密码是否符合要求，之后将用户名密码发送到后端相应的登录路径，并对后端响应进行操作，进行相应的响应。向后端发送请求时需要使用 axios 进行请求发送，使用 qs 进行对象解析，否则无法发送数据。在 axios 发送 post 请求后，可以使用 then 进行数据的异步响应，此处的 response 即包括后端所发送的 json 对象。如果正确响应并且状态码为 1000 或者 1001，则表示登录成功，使用 ElementPlus 的 ElMessage 弹出一条“登录成功”提示。否则弹出错误提示。如果服务器没有能够正确响应，则使用 catch 对错误进行响应和记录。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">submit</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.form.username.length &lt; <span class="number">4</span>) &#123;</span><br><span class="line">        ElMessage.warning(<span class="string">&quot;用户名长度至少 4 位&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.form.userPwd.length &lt; <span class="number">6</span>) &#123;</span><br><span class="line">        ElMessage.warning(<span class="string">&quot;密码长度至少 6 位&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 直接向后端请求，后端传入参数为 null，需要通过 qs 进行对象解析传递</span></span><br><span class="line">    <span class="keyword">let</span> loginData = &#123;</span><br><span class="line">        <span class="attr">username</span>: <span class="built_in">this</span>.form.username,</span><br><span class="line">        <span class="attr">password</span>: <span class="built_in">this</span>.form.userPwd</span><br><span class="line">    &#125;</span><br><span class="line">    axios.post(<span class="string">&#x27;/api/login&#x27;</span>, qs.stringify(loginData))</span><br><span class="line">        .then(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (response.data.statusCode == <span class="number">1000</span>  response.data.statusCode == <span class="number">1001</span>) &#123;</span><br><span class="line">            ElMessage.success(<span class="string">&quot;登录成功&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ElMessage.error(response.data.statusMsg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">        .catch(<span class="function"><span class="keyword">function</span> (<span class="params">error</span>) </span>&#123;</span><br><span class="line">        ElMessage.error(<span class="string">&quot;未知错误&quot;</span>);</span><br><span class="line">        <span class="built_in">console</span>.log(error);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注册组件基本相同在此不再赘述。在事务处理组件中，如果用户权限不足，则后端不会正常响应，即返回的 http 状态码为 403 权限不足。此时 axios 会将 response 交给 catch 处理。因此如果在 catch 中发现 http 状态码为 403，则表示用户权限不足，弹出错误提示。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">axios.get(<span class="string">&#x27;/api/api/user/common&#x27;</span>)</span><br><span class="line">    .then(<span class="function"><span class="params">response</span> =&gt;</span> &#123;  <span class="comment">// 直接使用函数会使得 this 指向丢失，此时可以使用 =&gt; 使得 this 指向 vue</span></span><br><span class="line">    <span class="keyword">if</span> (response.data.statusCode == <span class="number">1000</span>) &#123;</span><br><span class="line">        ElMessage.success(<span class="string">&quot;请求成功&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.userReturn = <span class="string">&quot;用户你好&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (response.data.statusCode == <span class="number">4007</span>) &#123;</span><br><span class="line">        ElMessage.error(<span class="string">&quot;用户未登录&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.userReturn = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ElMessage.error(<span class="string">&quot;请求失败&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.userReturn = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line">    .catch(<span class="function"><span class="keyword">function</span> (<span class="params">error</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> response = error.response;</span><br><span class="line">    <span class="keyword">if</span> (response.status == <span class="number">403</span>) &#123;</span><br><span class="line">        ElMessage.error(<span class="string">&quot;用户权限不足&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (response.status == <span class="number">500</span>) &#123;</span><br><span class="line">        ElMessage.error(<span class="string">&quot;服务器错误&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ElMessage.error(<span class="string">&quot;未知错误&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="整合"><a href="#整合" class="headerlink" title="整合"></a>整合</h3><p>组件全部开发完成后，在 App.vue 中完成组件整合。在模板中使用 tabs 来选择组件，以此实现“假路由”。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">el-tabs</span> <span class="attr">class</span>=<span class="string">&quot;top-navigation&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">el-tab-pane</span> <span class="attr">label</span>=<span class="string">&quot;登录&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">login</span>&gt;</span><span class="tag">&lt;/<span class="name">login</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">el-tab-pane</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">el-tab-pane</span> <span class="attr">label</span>=<span class="string">&quot;注册&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">register</span>&gt;</span><span class="tag">&lt;/<span class="name">register</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">el-tab-pane</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">el-tab-pane</span> <span class="attr">label</span>=<span class="string">&quot;事务&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">main-office</span>&gt;</span><span class="tag">&lt;/<span class="name">main-office</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">el-tab-pane</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">el-tab-pane</span> <span class="attr">label</span>=<span class="string">&quot;登出&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">logout</span>&gt;</span><span class="tag">&lt;/<span class="name">logout</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">el-tab-pane</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">el-tabs</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在 js 中导入组件进行引入，从而在模板中使用组件。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Login <span class="keyword">from</span> <span class="string">&#x27;./components/Login.vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> Register <span class="keyword">from</span> <span class="string">&#x27;./components/Register.vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> MainOffice <span class="keyword">from</span> <span class="string">&#x27;./components/MainOffice&#x27;</span></span><br><span class="line"><span class="keyword">import</span> Logout <span class="keyword">from</span> <span class="string">&#x27;./components/Logout&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;App&#x27;</span>,</span><br><span class="line">  <span class="attr">components</span>: &#123;</span><br><span class="line">    Login,</span><br><span class="line">    Register,</span><br><span class="line">    MainOffice,</span><br><span class="line">    Logout</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后使用<code>npm run serve</code>指令启动 vue 项目，完成前端开发。</p>
<h2 id="总结与不足"><a href="#总结与不足" class="headerlink" title="总结与不足"></a>总结与不足</h2><p>总体来看项目已经完成了“权限认证”的功能，能够在整体上做到前后端分离，在后端做到权限认证、用户操作、处理请求、响应数据等基本功能，在前端做到发送请求、响应数据等。同时项目过程中也确实学习到一些新的技术，更主要的是学习到一些前后端分离、权限认证的思想和方法。</p>
<p>但项目还有很多不完善的地方，有很多方面值得去努力。在后端上，jdbc 模板操作数据库的方式较为低效且工作量大，代码复用低，没有面向接口编程，没有投入过真正的生产环境等等。在前端上，由于技术实力原因没有采用 Vue Router 动态路由组件导致用户体验不良，界面仍较为简陋，代码复用低，对前端项目理解浅薄等等。因此，未来的发展方向是：1、学习 MyBatis，简化数据库操作；2、学习设计模式；3、尝试将该项目投入真正的生产环境进行测试；4、学习 Vue Router，更好地开发单页面应用；5、加深 JavaScript 理解。</p>
<h2 id="写在最后"><a href="#写在最后" class="headerlink" title="写在最后"></a>写在最后</h2><p>终于写完了，不管是项目本体还是这一份文档（实验报告）。总的来说这一次项目内容确实非常的少，但学到的东西确实很多。抛开框架怎么用这些纯粹没什么含量的技能，至少在前后端分离思想、单页面应用的逻辑、RESTful 接口、权限认证的作用上我确实学到很多（也明白了为什么全栈不可能）。这是一个好的开始，不管是从成功上还是不足上，它都有很多亮点。所以就以此为基开始漫长的全栈之旅吧，哪怕不为了什么“屠龙”什么“基本功”。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.saltroping.com/2021/04/12/%E8%AE%B0%E4%B8%80%E6%AC%A1%E4%BD%BF%E7%94%A8-springboot-spring-security-vue-%E7%9A%84%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%E6%9D%83%E9%99%90%E8%AE%A4%E8%AF%81/" data-id="cktlfnvx3000onxuk3n3zhfsy" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-线段树浅析-植树节限定-上" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/03/12/%E7%BA%BF%E6%AE%B5%E6%A0%91%E6%B5%85%E6%9E%90-%E6%A4%8D%E6%A0%91%E8%8A%82%E9%99%90%E5%AE%9A-%E4%B8%8A/" class="article-date">
  <time datetime="2021-03-12T15:22:36.000Z" itemprop="datePublished">2021-03-12</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%88%B7%E9%A2%98/">刷题</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/03/12/%E7%BA%BF%E6%AE%B5%E6%A0%91%E6%B5%85%E6%9E%90-%E6%A4%8D%E6%A0%91%E8%8A%82%E9%99%90%E5%AE%9A-%E4%B8%8A/">线段树浅析-植树节限定-上</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>线段树是刷题中一种常用的数据结构，其可以在<code>O(logN)</code>的复杂度内实现修改单个点、修改区间、区间求和、区间最大值、区间最小值等操作。那么线段树究竟是如何做到这一点的、线段树用代码又该如何实现，借着植树节的这个时间，我来浅析（学习）一下线段树的方方面面。  </p>
<h2 id="组成与构建"><a href="#组成与构建" class="headerlink" title="组成与构建"></a>组成与构建</h2><p>简单点说，线段树就是由“区间”组成的二叉树，其结点表示的是某段区间上的区间和，而结点的子结点便是区间的左子区间和右子区间。</p>
<p>假如有一个长度为 6 的数组<code>[1,2,3,4,5,6]</code>，我们便可构建如下的线段树。其中我们用<code>d(n)</code>表示编号为<code>n</code>的结点所存储的数值，即结点所保存的区间上的区间和。观察这棵树的性质，我们首先可以发现这是一棵完全二叉树，且其叶子结点所表示区间的区间长度均为 1。同时对于一个节点<code>n</code>，假设其表示的区间为<code>[l,r]</code>，那么它左子结点编号为<code>2n</code>，所表示的区间长度为<code>[l,\frac&#123;l+r&#125;&#123;2&#125;]</code>，而右子结点编号为<code>2n+1</code>，所表示的区间长度为<code>[\frac&#123;l+r&#125;&#123;2&#125;+1,r]</code>。而如果采用这样的存储方式，那么假设有<code>n</code>个叶子结点，即原数组长度为<code>n</code>的话，数组<code>d</code>的长度最多为<code>2^&#123;\left \lceil log n \right \rceil +1&#125;</code>（一般开 4n 的空间就够用；证明见参考资料）。</p>
<p><img src="http://www.saltroping.com/wp-content/uploads/2021/03/%E7%BA%BF%E6%AE%B5%E6%A0%91%E6%9E%84%E5%BB%BA.png" alt="线段树构建 "></p>
<p>根据这样的性质，我们可以轻易地构建出一棵线段树。假设原数组为<code>a</code>，要将其转化为一棵线段树。首先对于一个结点<code>n</code>，设其表示的区间为<code>[l,r]</code>。如果<code>l=r</code>，那么意味着其区间长度为 1，也就有<code>d[n]=a[l]=a[r]</code>。否则，我们可以通过其子结点的<code>d[n]</code>得到，即<code>d[n]=d[2n]+d[2n+1]</code>。那么他的子结点的<code>d[n]</code>如何得到呢，很简单，把上面这个过程重复一遍即可。</p>
<p>也就是说构建线段树的过程本质上是从根结点向下递归的过程，递归边界即是<code>l=r</code>。</p>
<h2 id="区间查询"><a href="#区间查询" class="headerlink" title="区间查询"></a>区间查询</h2><p>依旧以上图为例，如果我们要查询区间<code>[4,6]</code>的值，直接返回<code>d[3]=15</code>即可。那如果我们要查询区间<code>[2,6]</code>的值呢。区间<code>[2,6]</code>可以分解为区间<code>[2,3]</code>和区间<code>[4,6]</code>的值之和，而其中的区间<code>[2,3]</code>也可以进一步分解为区间<code>[2,2]</code>和区间<code>[3,3]</code>的值之和。同样我们发现区间查询也是一个不断递归的过程。</p>
<p>那么其具体规则是怎样的呢，我们如何知道返回哪个<code>d[n]</code>是正确的。很简单，如果我们要求区间<code>[s,t]</code>的区间和，那么它的“分解区间”必定是它的子集，而由线段树的性质可知，如果某个结点所表示的区间<code>[l,r]</code>不是<code>[s,t]</code>的子集，而它又和<code>[s,t]</code>有交集，那么<code>[l,r]</code>的子区间中必然存在属于<code>[s,t]</code>子集的区间。同样，使用这样的区间拆分也不存在某个区间算两次的问题。于是，经过子集、交集的判断，我们便可以通过递归求得所需区间的区间和。</p>
<h2 id="区间修改"><a href="#区间修改" class="headerlink" title="区间修改"></a>区间修改</h2><p>区间修改是线段树高效的核心，毕竟单点修改、区间查询这种问题前缀和就能在<code>O(1)</code>复杂度内解决。</p>
<p>线段树之所以能够在如此短的时间内做到区间修改，关键在于“懒惰标记”。在此处为了引入懒惰标记，我引用一下 OI Wiki 上的例子。</p>
<blockquote>
<p>A 有两个儿子，一个是 B，一个是 C。</p>
<p>有一天 A 要建一个新房子，没钱。刚好过年嘛，有人要给 B 和 C 红包，两个红包的钱数相同都是 元，然而因为 A 是父亲所以红包肯定是先塞给 A 咯~</p>
<p>理论上来讲 A 应该把两个红包分别给 B 和 C，但是……缺钱嘛，A 就把红包偷偷收到自己口袋里了。</p>
<p>A 高兴地说：「我现在有 2 份红包了！我又多了 2 元了！哈哈哈~」</p>
<p>但是 A 知道，如果他不把红包给 B 和 C，那 B 和 C 肯定会不爽然后导致家庭矛盾最后崩溃，所以 A 对儿子 B 和 C 说：「我欠你们每人 份 元的红包，下次有新红包给过来的时候再给你们！这里我先做下记录……嗯……我欠你们各 1 元……」</p>
<p>儿子 B、C 有点恼怒：「可是如果有同学问起我们我们收到了多少红包咋办？你把我们的红包都收了，我们还怎么装？」</p>
<p>父亲 A 赶忙说：「有同学问起来我就会给你们的！我欠条都写好了不会不算话的！」</p>
<p>这样 B、C 才放了心。</p>
</blockquote>
<p>懒惰标记正如故事中的“欠条”。当我们要求修改区间值加上某个数后，我们并不会直接加到那段区间上，而是先将其加在整个大区间里。直到“有同学问”时欠条才会更新，也就是直到我们查询某段区间的值时，包含这段区间的大区间上的懒惰标记才会逐步下传到查询区间，查询区间收到懒惰标记后就会加上已有的值直接返回区间和，不再下传标记。因此我们可以实现问哪里加哪里，降低复杂度的同时减少资源浪费。</p>
<p>那么具体应该如何实现懒惰标记的记录和下传。这里需要我们用一个懒惰标记数组<code>m[n]</code>表示编号为<code>n</code>的结点上的懒惰标记的值。我们依然以上图为例，假设我们为区间<code>[2,6]</code>的每一个元素增加 3，首先从根结点<code>d[1]</code>开始，因为<code>d[1]</code>所表示的区间并不是区间<code>[2,6]</code>的子区间，并且<code>d[1]</code>上也没有之前的懒惰标记不用下传，因此可以直接寻找<code>d[1]</code>子结点中和所需区间有交集的部分（原理同上区间查询）。所以我们首先找到了区间<code>[1,2]</code>和<code>[3,3]</code>，对于区间<code>[1,2]</code>重复刚才的操作，而对于<code>[3,3]</code>，这是所需区间的子区间，因此我们可以直接将其打上懒惰标记，即<code>m[5]+=3</code>，同时更新其区间和<code>d[5]+=(3-3+1)*m[5]=6</code>，至此我们应该已经为区间<code>[2,2]</code>，<code>[3,3]</code>都打上了懒惰标记并更新了区间和，因此为了使得上层大区间的区间和也能够响应这个变化，我们还需要将所更新的区间和返回以更新大区间的区间和。没错，就是递归，也就是当我们在区间<code>[1,3]</code>向下修改完子结点后，再更新区间和，即<code>d[n]=d[2n]+d[2n+1]</code>。</p>
<p>同理对于另一边的区间<code>[4,6]</code>，我们可以直接修改其区间和和懒惰标记。至此我们实现了第一次区间更新。之后多次区间更新基本都是这样的步骤，唯一的不同是，在之后的区间更新时，如果大区间中已经有一个懒惰标记，我们理应继续探索其子区间以增加懒惰标记和区间和，但是部分题目中不断增加懒惰标记可能导致数据溢出，因此我们常常在区间更新时，直接将大区间中上一次的懒惰标记下传，然后再探索子区间。</p>
<p>之后我们也需要略微改一下区间查询的步骤。如上述例子中的区间<code>[4,6]</code>，它在第一次更新之后有一个懒惰标记 3 还没有下传到子区间，而如果我们尝试询问区间<code>[6,6]</code>的值，按照区间查询的步骤，我们在递归至<code>[4,6]</code>时应该直接向下寻找子区间，但在区间更新中我们只更新了区间<code>[4,6]</code>的区间和，因此如果我们要查询它的子区间的区间和，我们首先应该将标记下传。也就是说，当区间查询时，如果区间上存在尚未清空的懒惰标记，我们需要将标记下传到指定区间，并清空区间上的标记。</p>
<p>至此我们实现了在<code>O(logN)</code>时间复杂度下的区间更新。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>写的略菜，毕竟我也是现学现用，甚至连题都还没做（这个会在“线段树浅析-下”中更新），中间很多文字阐述的部分可能过长，显得较为晦涩难懂，建议去 OI Wiki 上看一看图和代码实现（这个也会在之后更新），尤其要看代码实现，哪怕不做题、哪怕把自己当作人肉编译器，也要看明白代码实现，这是算法转化为实现的最重要的一步。同样网络上还有很多（比我写得好的）博客，可以拿来参考。</p>
<p>同时这篇博客也只是讲了最基本的线段树知识，也就是原理、构建、使用之类的。具体操作中线段树还有很多高端技巧，如“当懒惰标记累加不会发生溢出时，可以在区间更新时不下传标记”的标记持久化，“修改区间中所有元素为特定值”，“非递归线段树”等。具体也可以参考其他大佬的博客（Orz）。</p>
<p>虽说线段树仅仅是竞赛题目中较为常见的一种数据结构，但是线段树的高效率，以及它作为一种算法和数据结构所蕴含的思想是值得我们深入学习的。（也不保证随着内卷加剧线段树不会出现在面试中）</p>
<p>大概就是这些。最后，植树节快乐，希望世界上的程序员每写一棵树，地球就能多出一点绿色。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p>线段树 - OI Wiki（<a target="_blank" rel="noopener" href="https://oi-wiki.org/ds/seg/">https://oi-wiki.org/ds/seg/</a>）</p>
<p>线段树详解 - 岩之痕（<a target="_blank" rel="noopener" href="https://www.cnblogs.com/AC-King/p/7789013.html">https://www.cnblogs.com/AC-King/p/7789013.html</a>）</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.saltroping.com/2021/03/12/%E7%BA%BF%E6%AE%B5%E6%A0%91%E6%B5%85%E6%9E%90-%E6%A4%8D%E6%A0%91%E8%8A%82%E9%99%90%E5%AE%9A-%E4%B8%8A/" data-id="cktlfnvwr000fnxukd2shad73" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-写在2021年春节之前" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/02/11/%E5%86%99%E5%9C%A82021%E5%B9%B4%E6%98%A5%E8%8A%82%E4%B9%8B%E5%89%8D/" class="article-date">
  <time datetime="2021-02-11T14:38:35.000Z" itemprop="datePublished">2021-02-11</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%9D%82%E6%96%87/">杂文</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/02/11/%E5%86%99%E5%9C%A82021%E5%B9%B4%E6%98%A5%E8%8A%82%E4%B9%8B%E5%89%8D/">写在2021年春节之前</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>本来是像效仿大家在去年（2020）年底写一个年底总结的，不过想了想 2020 年也没有做什么事情，前半年受影响只能待在家里，当时还不清楚方向是什么该怎样去做，只能随便找个目标给点动力。现在想想当时以 ACM 为方向还是有点不妥，但好歹用在家半年的时间磨练了一下数据结构与算法，不过当时那种水平也只是能看罢了。后半年多少有点不同，放弃了 ACM、在别的系学自己喜欢的课、接触更多的人、尝试一些新鲜的东西、发展自己的技术栈。这些改变给我最大的感觉还是充实，相比之前的学习来说更有满足感，真正体现了 cs 的实践性，而不是一味的刷题。<br>现在想想轮子哥所说的不推荐 ACM 论是有道理的，ACM 本质上还是刷题竞赛，单论 ACM 本身来讲，其涉及到的 cs 理论、实践均不多，只是需要一定的智商和大量的练习，最好的证明便是我自己，哪怕一些最基本的常识都不会也能凭借 ide 和刷题刷到中等水平混牌子。ACM 需要投入大量的时间与精力，如果没有天赋与热情很难真正投入其中，而其回报率又很低，不能真正投入便很难真正”得到”什么，进一步打击自身的热情与自信。总之 ACM 是一个非常艰难的过程，坦白来讲它也只是某一部分精英的登云梯，当然 ACM 也并非全是弯路，ACM 经历是很好的锻炼，也是对 cs 的一个相对比较好的入门（反正我觉得从 oi 入门比从拿 cpp 做游戏入门好一些）。从这个角度上讲，学 cs 最好的路径应该是高中 oi 大学学术或者工程。<br>算到现在确切地说我真正学 cs 只有一年，也就是只有去年一年，再往前不是在绕远路就是在混日子，没有几天真正学进去的。大概是当时确实无法理解。还记得第一次接触深搜的概念，算法本身并不难，所需要用到的递归法我也能大概理解概念，但就是无法理解何谓”给走过的地方打上标记”，何谓”回溯”，直到后来静下心来当人肉编译器才理解这些过程是如何用代码实现的。<br>从这个角度上讲，代码实现是 cs 一项必备的能力，也是初学 cs 时最大的考验之一。cs 的本质是抽象现实世界，而代码实现便是这一过程的外壳。初学者最困难的地方大概是如何用这样密密麻麻英文单词拼接起来的读不通顺的文章表达现实世界的逻辑与事件。cs 的诸多教程、书籍都没有对这一部分有过教学乃至介绍，但这些教程无一例外都是建立在这一基础上的，因此这样的能力还是越早锻炼越好。<br>有一说一，制作游戏能够较大程度地锻炼代码实现能力。本质上来说，游戏也是抽象现实世界，因此游戏的种种规则设定可以较为规整地用逻辑表述出来，而再去制作它，一方面较为简单（简单是单从逻辑层面来说，整个游戏的制作并不简单），另一方面可以清楚地看到反馈。<br>因此 oi 和游戏制作其实都有适合初学者的地方，oi 更为系统更为学术，能够为游戏制作提供必要的算法数据结构知识，而游戏制作又能化编程为整活，锻炼自身在项目开发中的能力，给自己更大的满足感。<br>这么说来我在初中阶段还曾使用 gamemaker 引擎制作过一些很小规模的游戏，无奈当时只能找到 gamemaker gui 界面下的教程，涉及到语言脚本便没有了教学，身边又没有搞 cs 的人帮助，最终游戏也停留在一些十分简单的逻辑上，没有向深层次的 cs 知识深入。所以早期多问别人多找资料偶尔找成年人帮忙还是非常关键的。很多人小时候就对奇怪的计算机非常好奇，但大多没有引导，便渐渐没了兴趣。<br>大概就写这么多吧，写到最后就写成了对 cs 初学者的一些建议。毕竟我也是一个初学者，这些就当做我学 cs 的一些经验总结吧。<br>本篇文写在 2021 年 2 月 11 日晚 22 点，写在 2021 年春节之前，希望我在新的一年中能够继续坚持自己坚持自己的道路与梦想，也希望大家在新的一年中过得开心万事顺心。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.saltroping.com/2021/02/11/%E5%86%99%E5%9C%A82021%E5%B9%B4%E6%98%A5%E8%8A%82%E4%B9%8B%E5%89%8D/" data-id="cktlfnvwk0008nxuk5k1baztq" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-leetcode周赛211" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/10/24/leetcode%E5%91%A8%E8%B5%9B211/" class="article-date">
  <time datetime="2020-10-24T08:18:40.000Z" itemprop="datePublished">2020-10-24</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%88%B7%E9%A2%98/">刷题</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/10/24/leetcode%E5%91%A8%E8%B5%9B211/">Leetcode 周赛 211</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="A-两个相同字符之间的最长子字符串"><a href="#A-两个相同字符之间的最长子字符串" class="headerlink" title="A 两个相同字符之间的最长子字符串"></a>A 两个相同字符之间的最长子字符串</h2><p><strong>题目</strong></p>
<p>给你一个字符串 s，请你返回 两个相同字符之间的最长子字符串的长度 ，计算长度时不含这两个字符。如果不存在这样的子字符串，返回 -1 。</p>
<p>子字符串 是字符串中的一个连续字符序列。</p>
<p><strong>思路</strong></p>
<p>记录一个存储每个小写字母出现的开始位置的数组，遍历串维护最长子字符串即可。</p>
<p><strong>实现</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">maxLengthBetweenEqualCharacters</span>(<span class="params">self, s: <span class="built_in">str</span></span>) -&gt; <span class="built_in">int</span>:</span></span><br><span class="line">        a = [-<span class="number">1</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">26</span>)]</span><br><span class="line">        ans = -<span class="number">1</span></span><br><span class="line">        <span class="keyword">for</span> j,i <span class="keyword">in</span> <span class="built_in">enumerate</span>(s):</span><br><span class="line">            <span class="keyword">if</span> a[<span class="built_in">ord</span>(i)-<span class="built_in">ord</span>(<span class="string">&#x27;a&#x27;</span>)] != -<span class="number">1</span>:</span><br><span class="line">                ans = <span class="built_in">max</span>(ans, j-a[<span class="built_in">ord</span>(i)-<span class="built_in">ord</span>(<span class="string">&#x27;a&#x27;</span>)]-<span class="number">1</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                a[<span class="built_in">ord</span>(i)-<span class="built_in">ord</span>(<span class="string">&#x27;a&#x27;</span>)] = j</span><br><span class="line">        <span class="keyword">return</span> ans</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="B-执行操作后字典序最小的字符串"><a href="#B-执行操作后字典序最小的字符串" class="headerlink" title="B 执行操作后字典序最小的字符串"></a>B 执行操作后字典序最小的字符串</h2><p><strong>题目</strong></p>
<p>给你一个字符串 s 以及两个整数 a 和 b 。其中，字符串 s 的长度为偶数，且仅由数字 0 到 9 组成。</p>
<p>你可以在 s 上按任意顺序多次执行下面两个操作之一：</p>
<ul>
<li>  累加：将 a 加到 s 中所有下标为奇数的元素上（下标从 0 开始）。数字一旦超过 9 就会变成 0，如此循环往复。例如，s = “3456” 且 a = 5，则执行此操作后 s 变成 “3951”。</li>
<li>  轮转：将 s 向右轮转 b 位。例如，s = “3456” 且 b = 1，则执行此操作后 s 变成 “6345”。</li>
</ul>
<p>请你返回在 s 上执行上述操作任意次后可以得到的 字典序最小 的字符串。</p>
<p>如果两个字符串长度相同，那么字符串 a 字典序比字符串 b 小可以这样定义：在 a 和 b 出现不同的第一个位置上，字符串 a 中的字符出现在字母表中的时间早于 b 中的对应字符。例如，”0158” 字典序比 “0190” 小，因为不同的第一个位置是在第三个字符，显然 ‘5’ 出现在 ‘9’ 之前。</p>
<p><strong>思路</strong></p>
<p>算是到比较麻烦的题。</p>
<p>首先我们可以看一下这两个操作的性质。轮转操作有一个关键的性质，由于 s 的长度一定为偶数，当轮转长度为偶数时，那么累加操作永远不会施加到下标为偶数的元素上，反之如果轮转长度为奇数，那么每一个元素都可以施加累加操作。</p>
<p>对于累加操作，可以分为对下标为奇数的元素的累加和对下标为偶数的元素的累加，因为累加只能增加 0-9，因此完全可以将这几种情况遍历一遍，预处理出奇数位和偶数位经过若干次累加操作后所能得到的字符串。</p>
<p>之后便可以暴力求解。轮转相当于在一个长度为串 s 和轮转长度 b 的最小公倍数的循环字符串中按步长为 b 进行遍历。之后只要按照特定的位置切分原字符串维护一个字典序最小的答案即可。详见实现。</p>
<p><strong>实现</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">findLexSmallestString</span>(<span class="params">self, s: <span class="built_in">str</span>, a: <span class="built_in">int</span>, b: <span class="built_in">int</span></span>) -&gt; <span class="built_in">str</span>:</span></span><br><span class="line">        <span class="comment"># 预处理累加操作后的字符串</span></span><br><span class="line">        d = [[<span class="string">&#x27;&#x27;</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>)] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>)]</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">                <span class="keyword">for</span> z,t <span class="keyword">in</span> <span class="built_in">enumerate</span>(s):</span><br><span class="line">                    <span class="keyword">if</span> z%<span class="number">2</span>:</span><br><span class="line">                        d[i][j] += <span class="built_in">str</span>((<span class="built_in">int</span>(t) + a*j) % <span class="number">10</span>)</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        d[i][j] += <span class="built_in">str</span>((<span class="built_in">int</span>(t) + a*i) % <span class="number">10</span>)</span><br><span class="line">        <span class="comment"># 暴力遍历</span></span><br><span class="line">        ans = <span class="string">&#x27;9&#x27;</span> * <span class="built_in">len</span>(s)</span><br><span class="line">        <span class="comment"># 如果 b 是奇数那么要遍历每一位上的累加操作</span></span><br><span class="line">        <span class="keyword">if</span> b%<span class="number">2</span>:</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> d:</span><br><span class="line">                <span class="keyword">for</span> j <span class="keyword">in</span> i:</span><br><span class="line">                    <span class="keyword">for</span> t <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, (<span class="built_in">len</span>(s)*b)//gcd(<span class="built_in">len</span>(s), b), b):</span><br><span class="line">                        ans = <span class="built_in">min</span>(ans, j[t%<span class="built_in">len</span>(s):]+j[:t%<span class="built_in">len</span>(s)]) <span class="comment"># t%len(s) 表示切分原字符串的位置</span></span><br><span class="line">            <span class="keyword">return</span> ans</span><br><span class="line">        <span class="comment"># 如果是 b 是偶数那么只要遍历偶数位上的累加操作</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> d[<span class="number">0</span>]:</span><br><span class="line">                <span class="keyword">for</span> t <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, (<span class="built_in">len</span>(s)*b)//gcd(<span class="built_in">len</span>(s), b), b):</span><br><span class="line">                    ans = <span class="built_in">min</span>(ans, i[t%<span class="built_in">len</span>(s):]+i[:t%<span class="built_in">len</span>(s)])</span><br><span class="line">            <span class="keyword">return</span> ans</span><br></pre></td></tr></table></figure>

<h2 id="C-无矛盾的最佳球队"><a href="#C-无矛盾的最佳球队" class="headerlink" title="C 无矛盾的最佳球队"></a>C 无矛盾的最佳球队</h2><p><strong>题目</strong></p>
<p>假设你是球队的经理。对于即将到来的锦标赛，你想组合一支总体得分最高的球队。球队的得分是球队中所有球员的分数 总和 。</p>
<p>然而，球队中的矛盾会限制球员的发挥，所以必须选出一支 没有矛盾 的球队。如果一名年龄较小球员的分数 严格大于 一名年龄较大的球员，则存在矛盾。同龄球员之间不会发生矛盾。</p>
<p>给你两个列表 scores 和 ages，其中每组 scores[i] 和 ages[i] 表示第 i 名球员的分数和年龄。请你返回 所有可能的无矛盾球队中得分最高那支的分数 。</p>
<p><strong>思路</strong></p>
<p>动态规划。先将数组按照年龄和分数重排，<code>dp[i]</code>表示在前 i 名中选取球员并且最后一名为第 i 名时所能得到的最大分数。</p>
<p>这里用到了贪心的思想，最后一名为第 i 名时，第 i 名的分数一定是小于或等于其后的同年龄的球员的分数。这里类似 LIS。</p>
<p>至于状态转移直接在前 i 名球员中遍历即可。状态转移方程可以写为<code>dp[i]=max\&#123;j\lt idp[j]\&#125;+scores[i]</code></p>
<p><strong>实现</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">bestTeamScore</span>(<span class="params">self, scores: <span class="type">List</span>[<span class="built_in">int</span>], ages: <span class="type">List</span>[<span class="built_in">int</span>]</span>) -&gt; <span class="built_in">int</span>:</span></span><br><span class="line">        l = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(scores)):</span><br><span class="line">            l.append([ages[i], scores[i]])</span><br><span class="line">        l = <span class="built_in">sorted</span>(l, key=<span class="keyword">lambda</span> x:(x[<span class="number">0</span>], x[<span class="number">1</span>]))</span><br><span class="line">        ans = <span class="number">0</span></span><br><span class="line">        dp = [<span class="number">0</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(scores))]</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(dp)):</span><br><span class="line">            maxn = <span class="number">0</span></span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(i):</span><br><span class="line">                <span class="keyword">if</span> l[j][<span class="number">0</span>] == l[i][<span class="number">0</span>] <span class="keyword">or</span> l[j][<span class="number">1</span>] &lt;= l[i][<span class="number">1</span>]:</span><br><span class="line">                    maxn = <span class="built_in">max</span>(maxn, dp[j])</span><br><span class="line">            <span class="comment"># 状态转移</span></span><br><span class="line">            dp[i] += maxn + l[i][<span class="number">1</span>]</span><br><span class="line">            ans = <span class="built_in">max</span>(ans, dp[i])</span><br><span class="line">        <span class="keyword">return</span> ans</span><br></pre></td></tr></table></figure>

<h2 id="D-带阈值的图的连通性"><a href="#D-带阈值的图的连通性" class="headerlink" title="D 带阈值的图的连通性"></a>D 带阈值的图的连通性</h2><p><strong>题目</strong></p>
<p>有 n 座城市，编号从 1 到 n 。编号为 x 和 y 的两座城市直接连通的前提是： x 和 y 的公因数中，至少有一个 严格大于 某个阈值 threshold 。更正式地说，如果存在整数 z ，且满足以下所有条件，则编号 x 和 y 的城市之间有一条道路：</p>
<ul>
<li>  x % z == 0</li>
<li>  y % z == 0</li>
<li>  z &gt; threshold</li>
</ul>
<p>给你两个整数 n 和 threshold ，以及一个待查询数组，请你判断每个查询 queries[i] = [ai, bi] 指向的城市 ai 和 bi 是否连通（即，它们之间是否存在一条路径）。</p>
<p>返回数组 answer ，其中 answer.length == queries.length 。如果第 i 个查询中指向的城市 ai 和 bi 连通，则 answer[i] 为 true ；如果不连通，则 answer[i] 为 false 。</p>
<p><strong>思路</strong></p>
<p>对于这一类连通性的问题都是对连通分量点集做并查集，因此只需遍历图中的边做并查集处理即可。而根据题意，我们只需要逆向思考遍历因数 z，对于 z 的两个倍数，在他们中做一条边。</p>
<p>但此题中我们很容易发现图中的边数量过多，直接遍历边的话复杂度太高。观察图，我们可以发现，当着眼于连通性时，图中的大量边并无用处，我们只需要将 z 的倍数从小到大连成链即可，因此在合并时只需要将倍数和因数“合并”即可。</p>
<p>最后考虑阈值，我们只需要从 threshold+1 开始向 n 的二分之一遍历即可。</p>
<p><strong>实现</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">areConnected</span>(<span class="params">self, n: <span class="built_in">int</span>, threshold: <span class="built_in">int</span>, queries: <span class="type">List</span>[<span class="type">List</span>[<span class="built_in">int</span>]]</span>) -&gt; <span class="type">List</span>[<span class="built_in">bool</span>]:</span></span><br><span class="line">        ans = []</span><br><span class="line">        <span class="comment"># 如果阈值为 0，那么因数 1 可以让所有数相连</span></span><br><span class="line">        <span class="keyword">if</span> threshold &lt; <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> queries:</span><br><span class="line">                ans.append(<span class="literal">True</span>)</span><br><span class="line">            <span class="keyword">return</span> ans</span><br><span class="line">        <span class="comment"># 并查集</span></span><br><span class="line">        fa = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n+<span class="number">1</span>):</span><br><span class="line">            fa.append(i)</span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">find</span>(<span class="params">a</span>):</span></span><br><span class="line">            <span class="keyword">if</span> a != fa[a]: fa[a] = find(fa[a])</span><br><span class="line">            <span class="keyword">return</span> fa[a]</span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">union</span>(<span class="params">a, b</span>):</span></span><br><span class="line">            a = find(a)</span><br><span class="line">            b = find(b)</span><br><span class="line">            <span class="keyword">if</span> a == b: <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">            fa[a] = b</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="comment"># 枚举因数</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(threshold+<span class="number">1</span>, n//<span class="number">2</span>+<span class="number">1</span>):</span><br><span class="line">            enu = <span class="number">2</span>*i</span><br><span class="line">            <span class="keyword">while</span> enu &lt;= n:</span><br><span class="line">                union(i, enu)</span><br><span class="line">                enu += i</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> queries:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> find(i[<span class="number">0</span>]) <span class="keyword">or</span> find(i[<span class="number">0</span>]) != find(i[<span class="number">1</span>]): ans.append(<span class="literal">False</span>)</span><br><span class="line">            <span class="keyword">else</span>: ans.append(<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> ans</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.saltroping.com/2020/10/24/leetcode%E5%91%A8%E8%B5%9B211/" data-id="cktlfnvwh0005nxuk89j5ajji" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-leetcode周赛210" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/10/21/leetcode%E5%91%A8%E8%B5%9B210/" class="article-date">
  <time datetime="2020-10-21T01:19:57.000Z" itemprop="datePublished">2020-10-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%88%B7%E9%A2%98/">刷题</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/10/21/leetcode%E5%91%A8%E8%B5%9B210/">Leetcode 周赛 210</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="A-括号的最大嵌套深度"><a href="#A-括号的最大嵌套深度" class="headerlink" title="A 括号的最大嵌套深度"></a>A 括号的最大嵌套深度</h2><p><strong>题目</strong></p>
<p>如果字符串满足一下条件之一，则可以称之为 有效括号字符串（valid parentheses string，可以简写为 VPS）：</p>
<p>字符串是一个空字符串 “”，或者是一个不为 “(“ 或 “)” 的单字符。 字符串可以写为 AB（A 与 B 字符串连接），其中 A 和 B 都是 有效括号字符串 。 字符串可以写为 (A)，其中 A 是一个 有效括号字符串 。 类似地，可以定义任何有效括号字符串 S 的 嵌套深度 depth(S)：</p>
<p>depth(“”) = 0 depth(A + B) = max(depth(A), depth(B))，其中 A 和 B 都是 有效括号字符串 depth(“(“ + A + “)”) = 1 + depth(A)，其中 A 是一个 有效括号字符串 例如：””、”()()”、”()(()())” 都是 有效括号字符串（嵌套深度分别为 0、1、2），而 “)(“ 、”(()” 都不是 有效括号字符串 。</p>
<p>给你一个 有效括号字符串 s，返回该字符串的 s 嵌套深度 。</p>
<p><strong>思路</strong></p>
<p>题目相当于在说有效括号字符串可以由文法<code>S \rightarrow SS,S \rightarrow (S),S \rightarrow a</code>生成，因此我们可以发现由这样的文法生成的语言中不存在无效的括号，如<code>(()</code>，<code>(((</code>，之类的，每一对括号内部的左右括号一定是匹配的，因此我们只需要遍历一遍字符串，在遍历中更新当前的嵌套深度<code>dep</code>，遇到左括号<code>dep++</code>，遇到右括号<code>dep--</code>，最终得到最大嵌套深度即可。</p>
<p><strong>实现</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">maxDepth</span>(<span class="params">self, s: <span class="built_in">str</span></span>) -&gt; <span class="built_in">int</span>:</span></span><br><span class="line">        ans = <span class="number">0</span></span><br><span class="line">        temp = <span class="number">0</span></span><br><span class="line">        stack = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> s:</span><br><span class="line">            <span class="keyword">if</span> i == <span class="string">&#x27;(&#x27;</span>:</span><br><span class="line">                temp += <span class="number">1</span></span><br><span class="line">            <span class="keyword">elif</span> i == <span class="string">&#x27;)&#x27;</span>:</span><br><span class="line">                temp -= <span class="number">1</span></span><br><span class="line">            ans = <span class="built_in">max</span>(ans, temp)</span><br><span class="line">        <span class="keyword">return</span> ans</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="B-最大网络秩"><a href="#B-最大网络秩" class="headerlink" title="B 最大网络秩"></a>B 最大网络秩</h2><p><strong>题目</strong></p>
<p>n 座城市和一些连接这些城市的道路 roads 共同组成一个基础设施网络。每个 roads[i] = [ai, bi] 都表示在城市 ai 和 bi 之间有一条双向道路。</p>
<p>两座不同城市构成的 城市对 的 网络秩 定义为：与这两座城市 直接 相连的道路总数。如果存在一条道路直接连接这两座城市，则这条道路只计算 一次 。</p>
<p>整个基础设施网络的 最大网络秩 是所有不同城市对中的 最大网络秩 。</p>
<p>给你整数 n 和数组 roads，返回整个基础设施网络的 最大网络秩 。</p>
<p><strong>思路</strong></p>
<p>原题中的数据量并不大，n 最大为 100，因此我们可以暴力枚举网络中的所有点对，求出网络的最大网络秩。</p>
<p>在枚举中，首先我们枚举第一个点，求出与它相邻的边。枚举第二个点时，我们需要考虑这两点间是否连通，如果这两点连通则与第二个点相邻的边中存在一条我们已经访问过的边，需要删去。</p>
<p><strong>实现</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">maximalNetworkRank</span>(<span class="params">self, n: <span class="built_in">int</span>, roads: <span class="type">List</span>[<span class="type">List</span>[<span class="built_in">int</span>]]</span>) -&gt; <span class="built_in">int</span>:</span></span><br><span class="line">        ans = <span class="number">0</span></span><br><span class="line">        out = [[] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n)]</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> roads:</span><br><span class="line">            out[i[<span class="number">0</span>]].append(i[<span class="number">1</span>])</span><br><span class="line">            out[i[<span class="number">1</span>]].append(i[<span class="number">0</span>])</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">            maxn = <span class="number">0</span></span><br><span class="line">            <span class="keyword">for</span> x,y <span class="keyword">in</span> <span class="built_in">enumerate</span>(out):</span><br><span class="line">                <span class="keyword">if</span> x != i:</span><br><span class="line">                    temp = <span class="built_in">len</span>(y)-<span class="number">1</span> <span class="keyword">if</span> i <span class="keyword">in</span> y <span class="keyword">else</span> <span class="built_in">len</span>(y)</span><br><span class="line">                    maxn = <span class="built_in">max</span>(maxn, temp)</span><br><span class="line">            ans = <span class="built_in">max</span>(ans, <span class="built_in">len</span>(out[i])+maxn)</span><br><span class="line">        <span class="keyword">return</span> ans</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="C-分割两个字符串得到回文串"><a href="#C-分割两个字符串得到回文串" class="headerlink" title="C 分割两个字符串得到回文串"></a>C 分割两个字符串得到回文串</h2><p><strong>题目</strong></p>
<p>给你两个字符串 a 和 b ，它们长度相同。请你选择一个下标，将两个字符串都在 相同的下标 分割开。由 a 可以得到两个字符串： aprefix 和 asuffix ，满足 a = aprefix + asuffix ，同理，由 b 可以得到两个字符串 bprefix 和 bsuffix ，满足 b = bprefix + bsuffix 。请你判断 aprefix + bsuffix 或者 bprefix + asuffix 能否构成回文串。</p>
<p>当你将一个字符串 s 分割成 sprefix 和 ssuffix 时， ssuffix 或者 sprefix 可以为空。比方说， s = “abc” 那么 “” + “abc” ， “a” + “bc” ， “ab” + “c” 和 “abc” + “” 都是合法分割。</p>
<p>如果 能构成回文字符串 ，那么请返回 true，否则返回 false 。</p>
<p>请注意， x + y 表示连接字符串 x 和 y 。</p>
<p><strong>思路</strong></p>
<p>（听说这题数据很烂，用很菜的方法就可以过…）</p>
<p>题目中的分割字符串即 a 的前缀+b 的后缀，或者 b 的前缀+a 的后缀，因此最终所得到的回文串的长度和 ab 的长度是一致的，而它又是个回文串，所以我们可以注意到的是如果其切割的下标不在字符串中点，那么回文串所靠近中点的一部分回文子串一定来源于 a 或 b 串的中间。</p>
<p>因此我们可以分别求出 ab 串的“中心回文子串”，即一个以原字符串的中点为中点的回文子串。之后可以分为两种情况，回文串中心来源于 a 或来源于 b。</p>
<p>如果来源于 a，我们把 a 串中的回文子串删去，同时将 b 串按照对应的长度切片，那么此时我们只需要两个指针，一个从 a 的左端开始一个从 b 的右端开始向中心遍历，检查两个指针是否相同即可，如果遍历超过一半则表示 ab 串可以通过分割得到回文串。需要注意的是我们也需要以 a 的右端 b 的左端为开始遍历一次。</p>
<p>同样如果来源于 b 也可以依照上面的方法处理。</p>
<p>（这个代码写得相当冗余了…存在大量代码浪费的地方…懒得改了…）</p>
<p><strong>实现</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">checkPalindromeFormation</span>(<span class="params">self, a: <span class="built_in">str</span>, b: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bool</span>:</span></span><br><span class="line">        <span class="comment"># 双指针遍历</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">chk</span>(<span class="params">s1, s2</span>):</span></span><br><span class="line">            l = <span class="number">0</span>; r = <span class="built_in">len</span>(s1)-<span class="number">1</span></span><br><span class="line">            <span class="keyword">while</span> l &lt; r <span class="keyword">and</span> s1[l] == s2[r]:</span><br><span class="line">                l += <span class="number">1</span></span><br><span class="line">                r -= <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span> l &gt;= r:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">            <span class="keyword">else</span>: <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        length = <span class="built_in">len</span>(a)</span><br><span class="line">        <span class="comment"># 长度分奇偶讨论</span></span><br><span class="line">        <span class="keyword">if</span> length%<span class="number">2</span>:</span><br><span class="line">            <span class="comment"># 依照 a 的中心回文子串切片</span></span><br><span class="line">            mid = (length-<span class="number">1</span>)//<span class="number">2</span>-<span class="number">1</span></span><br><span class="line">            <span class="keyword">while</span> mid &gt;= <span class="number">0</span> <span class="keyword">and</span> a[mid] == a[length-mid-<span class="number">1</span>]:</span><br><span class="line">                mid -= <span class="number">1</span></span><br><span class="line">            mid += <span class="number">1</span></span><br><span class="line">            temp1 = a[:mid]+a[length-mid:]; temp2 = b[:mid]+b[length-mid:]</span><br><span class="line">            <span class="keyword">if</span> chk(temp1, temp2) <span class="keyword">or</span> chk(temp1[::-<span class="number">1</span>], temp2[::-<span class="number">1</span>]): <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">            <span class="comment"># 依照 b 的中心回文子串切片</span></span><br><span class="line">            mid = (length-<span class="number">1</span>)//<span class="number">2</span>-<span class="number">1</span></span><br><span class="line">            <span class="keyword">while</span> mid &gt;= <span class="number">0</span> <span class="keyword">and</span> b[mid] == b[length-mid-<span class="number">1</span>]:</span><br><span class="line">                mid -= <span class="number">1</span></span><br><span class="line">            mid += <span class="number">1</span></span><br><span class="line">            temp1 = a[:mid]+a[length-mid:]; temp2 = b[:mid]+b[length-mid:]</span><br><span class="line">            <span class="keyword">if</span> chk(temp1, temp2) <span class="keyword">or</span> chk(temp1[::-<span class="number">1</span>], temp2[::-<span class="number">1</span>]): <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 依照 a 的中心回文子串切片</span></span><br><span class="line">            mid = length//<span class="number">2</span>-<span class="number">1</span></span><br><span class="line">            <span class="keyword">while</span> mid &gt;= <span class="number">0</span> <span class="keyword">and</span> a[mid] == a[length-mid-<span class="number">1</span>]:</span><br><span class="line">                mid -= <span class="number">1</span></span><br><span class="line">            mid += <span class="number">1</span></span><br><span class="line">            temp1 = a[:mid]+a[length-mid:]; temp2 = b[:mid]+b[length-mid:]</span><br><span class="line">            <span class="keyword">if</span> chk(temp1, temp2) <span class="keyword">or</span> chk(temp1[::-<span class="number">1</span>], temp2[::-<span class="number">1</span>]): <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">            <span class="comment"># 依照 b 的中心回文子串切片</span></span><br><span class="line">            mid = length//<span class="number">2</span>-<span class="number">1</span></span><br><span class="line">            <span class="keyword">while</span> mid &gt;= <span class="number">0</span> <span class="keyword">and</span> b[mid] == b[length-mid-<span class="number">1</span>]:</span><br><span class="line">                mid -= <span class="number">1</span></span><br><span class="line">            mid += <span class="number">1</span></span><br><span class="line">            temp1 = a[:mid]+a[length-mid:]; temp2 = b[:mid]+b[length-mid:]</span><br><span class="line">            <span class="keyword">if</span> chk(temp1, temp2) <span class="keyword">or</span> chk(temp1[::-<span class="number">1</span>], temp2[::-<span class="number">1</span>]): <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="D-统计子树中城市之间最大距离"><a href="#D-统计子树中城市之间最大距离" class="headerlink" title="D 统计子树中城市之间最大距离"></a>D 统计子树中城市之间最大距离</h2><p><strong>题目</strong></p>
<p>给你 n 个城市，编号为从 1 到 n 。同时给你一个大小为 n-1 的数组 edges ，其中 edges[i] = [ui, vi] 表示城市 ui 和 vi 之间有一条双向边。题目保证任意城市之间只有唯一的一条路径。换句话说，所有城市形成了一棵 树 。</p>
<p>一棵 子树 是城市的一个子集，且子集中任意城市之间可以通过子集中的其他城市和边到达。两个子树被认为不一样的条件是至少有一个城市在其中一棵子树中存在，但在另一棵子树中不存在。</p>
<p>对于 d 从 1 到 n-1 ，请你找到城市间 最大距离 恰好为 d 的所有子树数目。</p>
<p>请你返回一个大小为 n-1 的数组，其中第 d 个元素（下标从 1 开始）是城市间 最大距离 恰好等于 d 的子树数目。</p>
<p>请注意，两个城市间距离定义为它们之间需要经过的边的数目。</p>
<p><strong>思路</strong></p>
<p>题目数据量很小，n 最大只有 15，可以轻易地想到状压。通过状压来遍历树中的点集的同时需要判断这个点集是否能连通以减少遍历数量。</p>
<p>首先如果点集中只有一个点显然没有用。存在多个点时，可以考虑用并查集的思维进行快速判断。如果点集中两个点相邻即两个点中存在一条边，那么可以合并这两个点，连通分量数减 1。通过初始化将每个点设置为孤立点，连通分量数等于点数，之后遍历边，如果两点相邻则连通分量数减 1，最后判断连通分量数是否为 1。一般来说这样的方法是 NG 的，但在不存在环和重边的树上这样的方法可以进行判断。</p>
<p>判断为子树之后我们需要求出所得子树的直径，可以用 dfs 或 bfs 求（这样的话上面的判断过程也可以浓缩进来），考虑到点数不大，我们也可以暴力枚举点集中的所有点对，求点对最短距中的最长距，即<code>ans=max(min(dis(i,j)))&#123;i,j\in S\land i\neq j&#125;</code>。考虑到这里要经常用到<code>dis(i,j)</code>，因此我们可以先通过 floyd 去求出原树中所有点对间的最短距离。</p>
<p>（比赛的时候想到怎么状压 floyd 了，但奈何图论底子太差，忘了怎么写了…正好这里复习一下）</p>
<p><strong>实现</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">countSubgraphsForEachDiameter</span>(<span class="params">self, n: <span class="built_in">int</span>, edges: <span class="type">List</span>[<span class="type">List</span>[<span class="built_in">int</span>]]</span>) -&gt; <span class="type">List</span>[<span class="built_in">int</span>]:</span></span><br><span class="line">        <span class="comment"># Floyd 求出所有点对间的最短路径</span></span><br><span class="line">        dis = [[<span class="number">0x3f3f3f3f</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n)] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n)]</span><br><span class="line">        d = [<span class="number">0</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n-<span class="number">1</span>)]</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n): dis[i][i] = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> edges:</span><br><span class="line">            dis[i[<span class="number">0</span>]-<span class="number">1</span>][i[<span class="number">1</span>]-<span class="number">1</span>] = <span class="number">1</span></span><br><span class="line">            dis[i[<span class="number">1</span>]-<span class="number">1</span>][i[<span class="number">0</span>]-<span class="number">1</span>] = <span class="number">1</span></span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">                <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">                    dis[i][j] = <span class="built_in">min</span>(dis[i][j], dis[i][k] + dis[k][j])</span><br><span class="line">        <span class="comment"># 状压暴力枚举</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>**n+<span class="number">1</span>):</span><br><span class="line">            cur = <span class="number">0</span></span><br><span class="line">            node = []</span><br><span class="line">            <span class="keyword">while</span> i:</span><br><span class="line">                <span class="keyword">if</span> i&amp;<span class="number">1</span>:</span><br><span class="line">                    node.append(cur)</span><br><span class="line">                i = i &gt;&gt; <span class="number">1</span></span><br><span class="line">                cur += <span class="number">1</span></span><br><span class="line">            nodenum = <span class="built_in">len</span>(node)</span><br><span class="line">            <span class="comment"># 如果只有一个节点显然没有长度大于 0 的路径</span></span><br><span class="line">            <span class="keyword">if</span> nodenum == <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="comment"># 并查集思维判断是否连通</span></span><br><span class="line">            <span class="comment"># 遍历边，如果边的两端都在点集中说明这两点相邻，连通分量数减一</span></span><br><span class="line">            <span class="comment"># 因为两点间无重边，因此可以通过这样的方式判断</span></span><br><span class="line">            <span class="comment"># 最终如果点集是联通的，那么最终连通分量数为 1，如果不为 1 则表明不连通</span></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> edges:</span><br><span class="line">                <span class="keyword">if</span> i[<span class="number">0</span>]-<span class="number">1</span> <span class="keyword">in</span> node <span class="keyword">and</span> i[<span class="number">1</span>]-<span class="number">1</span> <span class="keyword">in</span> node:</span><br><span class="line">                    nodenum -= <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span> nodenum == <span class="number">1</span>:</span><br><span class="line">                <span class="comment"># 遍历点集中点对的路径，求出最长路</span></span><br><span class="line">                maxn = <span class="number">0</span></span><br><span class="line">                <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(node)):</span><br><span class="line">                    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(i+<span class="number">1</span>, <span class="built_in">len</span>(node)):</span><br><span class="line">                        maxn = <span class="built_in">max</span>(maxn, dis[node[i]][node[j]])</span><br><span class="line">                d[maxn-<span class="number">1</span>] += <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> d</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.saltroping.com/2020/10/21/leetcode%E5%91%A8%E8%B5%9B210/" data-id="cktm6nfyj0000c0v62ff55pp9" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/CS/">CS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%88%B7%E9%A2%98/">刷题</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9D%82%E6%96%87/">杂文</a></li></ul>
    </div>
  </div>


  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">May 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">April 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">February 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/05/22/%E4%BB%8E%E4%B8%8A%E6%89%8B-travis-ci-%E6%97%B6%E7%8A%AF%E7%9A%84%E9%94%99%E8%AF%AF%E8%81%8A%E8%B5%B7/">从上手 travis ci 时犯的错误聊起</a>
          </li>
        
          <li>
            <a href="/2021/04/12/%E8%AE%B0%E4%B8%80%E6%AC%A1%E4%BD%BF%E7%94%A8-springboot-spring-security-vue-%E7%9A%84%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%E6%9D%83%E9%99%90%E8%AE%A4%E8%AF%81/">记一次使用 SpringBoot + Spring Security + Vue 的前后端分离权限认证</a>
          </li>
        
          <li>
            <a href="/2021/03/12/%E7%BA%BF%E6%AE%B5%E6%A0%91%E6%B5%85%E6%9E%90-%E6%A4%8D%E6%A0%91%E8%8A%82%E9%99%90%E5%AE%9A-%E4%B8%8A/">线段树浅析-植树节限定-上</a>
          </li>
        
          <li>
            <a href="/2021/02/11/%E5%86%99%E5%9C%A82021%E5%B9%B4%E6%98%A5%E8%8A%82%E4%B9%8B%E5%89%8D/">写在2021年春节之前</a>
          </li>
        
          <li>
            <a href="/2020/10/24/leetcode%E5%91%A8%E8%B5%9B211/">Leetcode 周赛 211</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2021 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>